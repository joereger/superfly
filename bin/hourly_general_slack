#! /app/vendor/node/bin/node

var slack = require("../conf/slack.js");
var mongo = require("../conf/mongo.js");
var moment = require('moment');
var Async = require('async');

function hourly_general_slack() {
    top_slackers();
}
hourly_general_slack();


function top_slackers(){

    var start_date =  moment().subtract(1, 'days').calendar();
    var end_date = moment().calendar();

    var count = 0;
    Async.series([
        function step1(){
            console.log('about to run the count');
                mongo.SlackMessage.count(function(err, result){
                console.log( "result = :", result );
                count = result;
            });
            console.log('step 1 count = ' + count);
        },
        function step2(){
            console.log( "step 2 count = ", count );
            count = result;
        },
        function step3(){
            console.log('step 3 count = '+count);
            slack.slack_out.send({
                text: '' + count + ' slacks in the last 24 hours.',
                channel: '#test',
                username: 'Superfly',
            });
        }
    ]);
    console.log('out of step process');



//    var count = 0;
//    mongo.SlackMessage.count(function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    var count = 0;
//    mongo.SlackMessage.where({"datetime": {'$gte': start_date, '$lte': end_date}}).count(function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    var count = 0;
//    mongo.SlackMessage.count({"datetime": {'$gte': start_date, '$lte': end_date}}, function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    console.log('about to send slack msg count='+count);
//    slack.slack_out.send({
//        text: '' + count + ' slacks in the last 24 hours.',
//        channel: '#test',
//        username: 'Superfly',
//    });

}

