#! /app/vendor/node/bin/node

var slack = require("../conf/slack.js");
var mongo = require("../conf/mongo.js");
var moment = require('moment');
var Step = require('step');

function hourly_general_slack() {
    top_slackers();
}
hourly_general_slack();


function top_slackers(){

    var start_date =  moment().subtract(1, 'days').calendar();
    var end_date = moment().calendar();

    var count = 0;
    Step(
//        function getNumSlacks(){
//            mongo.SlackMessage.count(function(err, result){
//                console.log( "Number of slacks:", result );
//                count = result;
//                return;
//            });
//        },
        function getNumSlacks(){
            console.log('about to run the count');
            mongo.SlackMessage.count(this);
        },
        function logStuffs(err, result){
            if (err) throw err;
            console.log( "Number of slacks - result=", result );
            count = result;
        },
        function sendSlack(err, blah){
            if (err) throw err;
            console.log('about to send slack msg count='+count);
            slack.slack_out.send({
                text: '' + count + ' slacks in the last 24 hours.',
                channel: '#test',
                username: 'Superfly',
            });
        }
    );
    console.log('out of step process');

//    var count = 0;
//    mongo.SlackMessage.count(function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    var count = 0;
//    mongo.SlackMessage.where({"datetime": {'$gte': start_date, '$lte': end_date}}).count(function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    var count = 0;
//    mongo.SlackMessage.count({"datetime": {'$gte': start_date, '$lte': end_date}}, function(err, result){
//        console.log( "Number of slacks:", result );
//        count = result;
//    });

//    console.log('about to send slack msg count='+count);
//    slack.slack_out.send({
//        text: '' + count + ' slacks in the last 24 hours.',
//        channel: '#test',
//        username: 'Superfly',
//    });

}

